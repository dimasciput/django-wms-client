{% extends "base.html" %}
{% block meta_title %}{{ wms.name }}{% endblock %}
{% block title %}{{ wms.name }}{% endblock %}


{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

    <script>
        /*
         * L.Control.WMSLegend is used to add a WMS Legend to the map
         */

        L.Control.WMSLegend = L.Control.extend({
            options: {
                position: 'topright',
                uri: ''
            },

            onAdd: function () {
                var controlClassName = 'leaflet-control-wms-legend',
                        legendClassName = 'wms-legend',
                        stop = L.DomEvent.stopPropagation;
                this.container = L.DomUtil.create('div', controlClassName);
                this.img = L.DomUtil.create('img', legendClassName, this.container);
                this.img.src = this.options.uri;
                this.img.alt = 'Legend';

                L.DomEvent
                        .on(this.img, 'click', this._click, this)
                        .on(this.container, 'click', this._click, this)
                        .on(this.img, 'mousedown', stop)
                        .on(this.img, 'dblclick', stop)
                        .on(this.img, 'click', L.DomEvent.preventDefault)
                        .on(this.img, 'click', stop);
                this.height = null;
                this.width = null;
                return this.container;
            },
            _click: function (e) {
                L.DomEvent.stopPropagation(e);
                L.DomEvent.preventDefault(e);
                // toggle legend visibility
                var style = window.getComputedStyle(this.img);
                if (style.display === 'none') {
                    this.container.style.height = this.height + 'px';
                    this.container.style.width = this.width + 'px';
                    this.img.style.display = this.displayStyle;
                }
                else {
                    if (this.width === null && this.height === null) {
                        // Only do inside the above check to prevent the container
                        // growing on successive uses
                        this.height = this.container.offsetHeight;
                        this.width = this.container.offsetWidth;
                    }
                    this.displayStyle = this.img.style.display;
                    this.img.style.display = 'none';
                    this.container.style.height = '20px';
                    this.container.style.width = '20px';
                }
            }
        });

        L.wmsLegend = function (uri, map) {
            var wmsLegendControl = new L.Control.WMSLegend({uri: uri});
            map.addControl(wmsLegendControl);
            return wmsLegendControl;
        };
    </script>
{% endblock extra_head %}

{% block extra_css %}
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            position: absolute;
            top: 0px;
            left: 0px;
            height: 100%;
            width: 100%;
            background: white;
            z-index: 9999;
        }

        .leaflet-control-wms-legend {
            display: block;
            padding: 3px;
            border-radius: 4px;
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            box-shadow: 0 1px 7px rgba(0, 0, 0, 0.65);
            cursor: auto;
            text-align: center;
            background-color: #FFFFFF;
        }

        .leaflet-control-wms-legend:hover {
            background-color: #F4F4F4;
        }
    </style>

{% endblock extra_css %}


{% block main %}
    <div id="map"></div>
{% endblock %}

{% block extra_js %}
    <script>
        $(document).ready(function () {
            var north = "{{ wms.north }}".replace(',', '.');
            var east = "{{ wms.east }}".replace(',', '.');
            var south = "{{ wms.south }}".replace(',', '.');
            var west = "{{ wms.west }}".replace(',', '.');
            var map = L.map('map', {
                center: [{{ wms.center_south }}, {{ wms.center_east }}],
                zoom: {{ wms.zoom }},
                minZoom: {{ wms.min_zoom }},
                maxZoom: {{ wms.max_zoom }},
                maxBounds: [
                    [north, east], [south, west]
                ]
            });
            var qgis = L.tileLayer.wms("{{  wms.uri }}", {
                layers: '{{ wms.layers }}',
                format: 'image/png',
                transparent: true,
                attribution: '{{  wms.attribution|safe }}'
            }).addTo(map);
            var wms_legend_uri = "{{  wms.uri }}" + "&SERVICE=WMS&VERSION=1.3.0&SLD_VERSION=1.1.0&REQUEST=GetLegendGraphic&FORMAT=image/jpeg&LAYER=" + '{{ wms.layers }}' + "&STYLE=";
            L.wmsLegend(wms_legend_uri, map);
        });
    </script>
{% endblock extra_js %}
